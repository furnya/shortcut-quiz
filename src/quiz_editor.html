<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shortcut Quiz</title>
  </head>

  <body>
    <script type="module">
      import { h, render, Component } from 'https://esm.sh/preact';
      import htm from 'https://esm.sh/htm';
      const html = htm.bind(h);
      const vscode = acquireVsCodeApi();

      let keybindings = [];
      function init(shortcuts) {
        keybindings = shortcuts;

        function getStepsFromKeybinding(keybinding) {
          const steps = [];
          for (const step of keybinding.key.split(' ')) {
            const keys = step.toLowerCase().split('+');
            steps.push(keys);
          }
          return steps;
        }

        // Create your app
        // const app = h('h1', null, 'Hello World!');
        class MyComponent extends Component {
          constructor(props) {
            super(props);
            this.state = {
              currentKeybindingIndex: 0,
              steps: getStepsFromKeybinding(props.keybindings[0]),
              currentStep: 0,
            };
            console.log(this.state);
          }
          componentDidMount() {
            document.addEventListener('keydown', (event) => {
              console.log(event.key);
              const step = this.state.steps[this.state.currentStep];
              console.log(this.state.steps);
              console.log(this.state.currentStep);
              console.log(step);
              const pressedKey = event.key.toLowerCase();
              if (
                (!step.includes('ctrl') || event.ctrlKey) &&
                (!step.includes('shift') || event.shiftKey) &&
                (!step.includes('alt') || event.altKey) &&
                (!step.includes('meta') || event.metaKey) &&
                !['ctrl', 'shift', 'alt', 'meta'].includes(pressedKey) &&
                step.includes(pressedKey)
              ) {
                event.preventDefault(); // Prevent VS Code from handling it
                event.stopPropagation(); // Stop propagation to parent elements
                if (this.state.currentStep === this.state.steps.length - 1) {
                  // Show a message in the Webview
                  // vscode.postMessage({
                  //   command: 'alert',
                  //   text: 'You pressed the correct key combination!',
                  // });
                  // document.getElementById('answer').style.display = 'block';
                  this.showAnswer(true);
                } else {
                  this.setState((prev) => ({ currentStep: prev.currentStep + 1 }));
                }
              } else {
                this.setState((prev) => ({ currentStep: 0 }));
              }
            });
          }
          showAnswer(correct) {
            document.getElementById('answer').style.display = 'block';
            document.getElementById('next').style.display = 'block';
            vscode.postMessage({
              command: 'keybindingAnswer',
              correct,
              keybindingCommand: this.props.keybindings[this.state.currentKeybindingIndex].command,
            });
          }
          next() {
            document.getElementById('answer').style.display = 'none';
            document.getElementById('next').style.display = 'none';
            this.setState((prev) => ({
              currentKeybindingIndex: prev.currentKeybindingIndex + 1,
              steps: getStepsFromKeybinding(
                this.props.keybindings[prev.currentKeybindingIndex + 1],
              ),
              currentStep: 0,
            }));
            // if (currentKeybindingIndex === keybindings.length) {
            // TODO
            // }
          }
          render(props, state) {
            // return html`<div>
            //   ${keybindings.map(({ key, title }) => html`<h1>Key: ${key}, Title: ${title}</h1>`)}
            // </div>`;
            return html`<p>
                What is the shortcut for "${props.keybindings[state.currentKeybindingIndex].title}"?
                (${props.keybindings[state.currentKeybindingIndex].key})
              </p>
              <p>Press the key combination or show the answer if you forgot:</p>
              <button onClick="${() => this.showAnswer(false)}">Show Answer</button>
              <p id="answer" style="display: none">
                The shortcut for "${props.keybindings[state.currentKeybindingIndex].title}" is
                <strong id="keyAnswer">
                  ${' ' + props.keybindings[state.currentKeybindingIndex].key}</strong
                >
              </p>
              <button id="next" style="display: none" onClick="${() => this.next()}">Next</button>`;
          }
        }
        // const app = html`<MyComponent name="World" />`;
        // const app = html`<MyComponent2 name="World" />`;
        const app = h(MyComponent, { keybindings });

        render(app, document.body);
      }
      window.addEventListener('message', (event) => {
        const message = event.data; // The JSON data our extension sent
        if (message.command === 'setKeybindings') {
          init(message.keybindings);
        }
      });
    </script>
    <!-- <h1>Shortcut Quiz</h1> -->
  </body>
</html>
